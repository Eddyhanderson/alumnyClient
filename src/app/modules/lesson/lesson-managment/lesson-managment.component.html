<div class="main">
	<div class="section">
		<div class="mb-2 ">
			<h1 class="bold-500">
				{{draftMode ? 'Rascunho' : 'Aulas'}}
			</h1>
		</div>
		<div class="mat-elevation-z4" *ngIf="!draftMode; else draft">
			<div class="d-flex ml-2 mr-4 my-3">
				<button mat-icon-button [matMenuTriggerFor]="menu">
					<mat-icon>filter_list</mat-icon>
				</button>
				<div class="w-100 d-flex flex-column">
					<input class="form-control" #search type="text" (input)="data.setSearchValue = search.value"
						placeholder="Pesquisar aula">
						
					<mat-chip-list class="p-2">
						<mat-chip *ngFor="let filter of filters" [selectable]="selectable" removable="true"
							(removed)="remove(filter.id, filter.type)">
							{{filter.name}}
							<mat-icon matChipRemove>cancel</mat-icon>
						</mat-chip>						
					</mat-chip-list>
				</div>
				<mat-menu #menu="matMenu">
					<button mat-menu-item (click)="onSchoolFilterOpened()">
						<span>Filtrar por escola</span>
					</button>
					<button mat-menu-item (click)="onTeacherPlaceFilterOpened()">
						<span>Filtrar por turma</span>
					</button>
					<button mat-menu-item (click)="onTopicFilterOpened()">
						<span>Filtrar por tópico</span>
					</button>
					<button mat-menu-item (click)="switchMode()">
						<span>Ver os meus rascunhos</span>
					</button>
				</mat-menu>
			</div>

			<!-- School filter -->
			<div class="d-flex flex-column box-collapsable" [class.box-collapsable-opened]="schoolFilterOpened">
				<div class="d-flex justify-content-end mx-3" *ngIf="schoolFilterOpened">
					<button mat-icon-button (click)="schoolFilterOpened = false" class="mr-1">
						<mat-icon>
							close
						</mat-icon>
					</button>
				</div>
				<div class="mx-3">
					<ng-container *ngIf="schoolFilterOpened">
						<ng-container *ngIf="schools$ | async as schools; else loadingItems">
							<mat-selection-list #school [multiple]="false"
								(selectionChange)="onSchoolFilterPicked($event)">
								<mat-list-option *ngFor="let school of schools" [value]="school">
									{{school.name}}
								</mat-list-option>
							</mat-selection-list>
						</ng-container>
					</ng-container>
				</div>
			</div>
			<!-- End school -->

			<!-- Teacher place filter -->
			<div class="d-flex flex-column box-collapsable" [class.box-collapsable-opened]="teacherPlaceFilterOpened">
				<div class="d-flex justify-content-end mx-3" *ngIf="teacherPlaceFilterOpened">
					<button mat-icon-button (click)="teacherPlaceFilterOpened = false" class="mr-1">
						<mat-icon>
							close
						</mat-icon>
					</button>
				</div>
				<div class="mx-3">
					<ng-container *ngIf="teacherPlaceFilterOpened">
						<ng-container *ngIf="teacherPlaces$ | async as teacherPlaces; else loadingItems">
							<mat-selection-list #teacherPlace [multiple]="false"
								(selectionChange)="onTeacherPlaceFilterPicked($event)">
								<mat-list-option *ngFor="let teacherPlace of teacherPlaces" [value]="teacherPlace">
									{{teacherPlace.name}}
								</mat-list-option>
							</mat-selection-list>
						</ng-container>
					</ng-container>
				</div>
			</div>
			<!-- End teacher place filter -->

			<!-- Topic filter -->
			<div class="d-flex flex-column box-collapsable" [class.box-collapsable-opened]="topicFilterOpened">
				<div class="d-flex justify-content-end mx-3" *ngIf="topicFilterOpened">
					<button mat-icon-button (click)="topicFilterOpened = false" class="mr-1">
						<mat-icon>
							close
						</mat-icon>
					</button>
				</div>
				<div class="mx-3">
					<ng-container *ngIf="topicFilterOpened">
						<ng-container *ngIf="topics$ | async as topics; else loadingItems">
							<mat-selection-list #disciplineTopic [multiple]="false"
								(selectionChange)="onTopicFilterPicked($event)">
								<mat-list-option *ngFor="let topic of topics" [value]="topic">
									{{topic.disciplineTopicName}}
								</mat-list-option>
							</mat-selection-list>
						</ng-container>
					</ng-container>
				</div>
			</div>
			<!-- End teacher place filter -->

			<table mat-table [dataSource]="data">
				<!-- Position Column -->
				<ng-container matColumnDef="lesson">
					<th mat-header-cell *matHeaderCellDef>
						<mat-checkbox (change)="$event ? masterToggle() : null"
							[checked]="selection.hasValue() && isAllSelected()"
							[indeterminate]="selection.hasValue() && !isAllSelected()">
						</mat-checkbox>
						<span class="ml-2">
							Aula
						</span>
					</th>
					<td mat-cell *matCellDef="let element">
						<div class="d-flex justify-content-start align-items-center">
							<mat-checkbox (click)="$event.stopPropagation()"
								(change)="$event ? selection.toggle(element) : null"
								[checked]="selection.isSelected(element)">
							</mat-checkbox>
							<div class="img-profile-thumbnail-md">
								<img [src]="element.backgroundPhotoPath">
							</div>
							<span>
								Aula nº {{element.sequence}} - {{element.title}}
							</span>
						</div>
					</td>
				</ng-container>

				<!-- Name Column -->
				<ng-container matColumnDef="school">
					<th mat-header-cell *matHeaderCellDef> Escola </th>
					<td mat-cell *matCellDef="let element"> {{element.schoolName}} </td>
				</ng-container>

				<!-- Teacher Place Column -->
				<ng-container matColumnDef="place">
					<th mat-header-cell *matHeaderCellDef> Turma </th>
					<td mat-cell *matCellDef="let element"> {{element.teacherPlaceName}} </td>
				</ng-container>

				<!-- Weight Column -->
				<ng-container matColumnDef="topic">
					<th mat-header-cell *matHeaderCellDef> Tópico </th>
					<td mat-cell *matCellDef="let element"> {{element.disciplineTopicName}} </td>
				</ng-container>

				<!-- Symbol Column -->
				<ng-container matColumnDef="type">
					<th mat-header-cell *matHeaderCellDef> Tipo </th>
					<td mat-cell *matCellDef="let element">
						{{element.lessonType.toUpperCase() == 'VIDEO' ? 'Video' : 'Artigo'}}
					</td>
				</ng-container>

				<ng-container matColumnDef="date">
					<th mat-header-cell *matHeaderCellDef>
						Data
					</th>
					<td mat-cell *matCellDef="let element">
						{{element.date | date:'yyyy/MM/dd'}}
					</td>
				</ng-container>

				<ng-container matColumnDef="views">
					<th mat-header-cell *matHeaderCellDef>
						Visualizações
					</th>
					<td mat-cell *matCellDef="let element">
						{{element.views}}
					</td>
				</ng-container>

				<tr mat-header-row *matHeaderRowDef="displayedColumns">
				</tr>
				<tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
			</table>

			<mat-paginator *ngIf="data.dataSource$ | async as page" [length]="page.totalElements"
				[pageSize]="page.data.length" [pageIndex]="page.pageNumber - 1" [hidePageSize]="true"
				(page)="data.fetch($event.pageIndex)">
			</mat-paginator>
		</div>
		<ng-template #draft>
			<div class="mat-elevation-z4">
				<div class="d-flex ml-2 mr-4 my-3">
					<button mat-icon-button [matMenuTriggerFor]="menu">
						<mat-icon>filter_list</mat-icon>
					</button>
					<div class="w-100 ">
						<input class="form-control" #search type="text"
							(input)="draftData.setSearchValue = search.value" placeholder="Pesquisar rascunho">
					</div>
					<mat-menu #menu="matMenu">
						<button mat-menu-item (click)="switchMode()">
							<span>Ver as aulas</span>
						</button>
					</mat-menu>
				</div>

				<table mat-table [dataSource]="draftData">
					<!-- Position Column -->
					<ng-container matColumnDef="draft">
						<th mat-header-cell *matHeaderCellDef>
							<span class="ml-2">
								Rascunho
							</span>
						</th>
						<td mat-cell *matCellDef="let element">
							<div class="d-flex justify-content-start align-items-center">
								<div class="img-profile-thumbnail-md">
									<mat-icon [style]="{'fontSize':'3rem'}">
										note
									</mat-icon>
								</div>
							</div>
						</td>
					</ng-container>

					<!-- Name Column -->
					<ng-container matColumnDef="name">
						<th mat-header-cell *matHeaderCellDef> Nome </th>
						<td mat-cell *matCellDef="let element"> {{element.name}} </td>
					</ng-container>

					<!-- Teacher Place Column -->
					<ng-container matColumnDef="changeAt">
						<th mat-header-cell *matHeaderCellDef> Última modificação </th>
						<td mat-cell *matCellDef="let element"> {{element.lastChange | date:'yyyy/MM/dd hh:mm'}} </td>
					</ng-container>

					<!-- Teacher Place Column -->
					<ng-container matColumnDef="action">
						<th mat-header-cell *matHeaderCellDef> Acção </th>
						<td mat-cell *matCellDef="let element">
							<div class="d-flex justify-content-evenly align-items-center">
								<button mat-stroked-button matTooltip="Continuar a edição"
									(click)="openArticleCreation(element)">
									editar <mat-icon [style]="{'fontSize':'1rem', 'marginTop':'0.4rem'}">description
									</mat-icon>
								</button>
								<button mat-stroked-button matTooltip="Ver">
									ver <mat-icon [style]="{'fontSize':'1rem','marginTop':'0.4rem'}">insert_drive_file
									</mat-icon>
								</button>
								<button mat-stroked-button matTooltip="Apagar">
									apagar <mat-icon [style]="{'fontSize':'1rem', 'marginTop':'0.4rem'}">delete
									</mat-icon>
								</button>
							</div>
						</td>
					</ng-container>

					<tr mat-header-row *matHeaderRowDef="draftColumns">
					</tr>
					<tr mat-row *matRowDef="let row; columns: draftColumns;"></tr>
				</table>

				<mat-paginator *ngIf="draftData.dataSource$ | async as page" [length]="page.totalElements"
					[pageSize]="page.data.length" [pageIndex]="page.pageNumber - 1" [hidePageSize]="true"
					(page)="draftData.fetch($event.pageIndex)">
				</mat-paginator>
			</div>
		</ng-template>
	</div>
</div>

<!-- Shared views -->
<ng-template #loadingItems>
	<div class="w-100 h-25 d-flex justify-content-center">
		<mat-spinner color="primary" diameter=20 margin="auto" *ngIf="data.loading"></mat-spinner>
	</div>
</ng-template>